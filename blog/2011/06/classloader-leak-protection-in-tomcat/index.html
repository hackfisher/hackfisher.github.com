
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ClassLoader Memory Leak: Detection and Protection in Tomcat</title>
    
    <meta name="author" content="HackFisher">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>
    <div class="container">
		<header>
			<h1><a href="/">HackFisher</a>  <small>Stay foolish, Stay hungry</small></h1>
		</header>
		<div class="navbar">
		  <div class="container">
		      <ul class="nav">
		        
		        
		        


  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/projects.html">Project</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



		      </ul>
		      <form action="http://google.com/search" method="get" class="nav">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hackfisher.info">
    <input class="search" type="text" name="q" results="0" placeholder="Search">
  </fieldset>
</form>

<ul class="subscription nav" data-subscription="rss">
  <li><a href="/rss.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> 
</ul>
		    </div>
		</div>
		  <div class="content">
		    
<div class="page-header">
  <h2>ClassLoader Memory Leak: Detection and Protection in Tomcat </h2>
</div>

<div class="row">
  <div class="span8">
    æœ€è¿‘åœ¨tomcat 6ä¸‹é¢é‡æ–°éƒ¨ç½²åº”ç”¨æ—¶ï¼Œå‘ç°äº†ä¸‹é¢ä¸€ä¸ªæŠ›é”™ï¼Œéå¸¸å›°æƒ‘ï¼Œæ‰€ä»¥å°±ç ”ç©¶äº†ä¸€ä¸‹ã€‚

org.apache.catalina.loader.WebappClassLoader clearThreadLocalMapä¸¥é‡: The web application [/test] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@c47498]) and a value of type [XXX] (value [XXX@1c2dad7]) but failed to remove it when the web application was stopped.

æŒ‰é“ç†ï¼ŒThreadLocalåœ¨çº¿ç¨‹å…³é—­æ—¶ï¼Œä¼šè‡ªåŠ¨è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œæ‰€ä»¥ä¸€èˆ¬å°±ç®—ä¸removeä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œäº¤ç»™Threadäº†ã€‚é‚£ä¸ºä»€ä¹ˆè¿™è¾¹ä¼šæœ‰æŠ›é”™ï¼Œéå¸¸ä¸è§£, Tomcatè¿™ä¹ˆåšè‚¯å®šæœ‰å®ƒçš„é“ç†ï¼Œæ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

ä»”ç»†åˆ†æåå‘ç°ï¼ŒWebå®¹å™¨ä¸­çº¿ç¨‹åœ¨ä¸åŒçš„Requestå’ŒServletä¹‹é—´æ˜¯ä¼šé‡å¤åˆ©ç”¨çš„ï¼ŒåŒ…æ‹¬undeployä¹‹ådeployï¼Œçº¿ç¨‹è¿˜ä¼šå­˜åœ¨ï¼Œä»æŸç§æ„ä¹‰ä¸Šå°±æœ‰ç‚¹åƒå…¨å±€å˜é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åº”ç”¨é‡æ–°éƒ¨ç½²åThreadLocalå¹¶ä¸ä¼šè¢«removeï¼Œé‚£å¦‚æœThreadLocalé‡Œé¢æ”¾çš„å¯¹è±¡å¾ˆå°ï¼Œæ¯•ç«Ÿæ˜¯å…¨å±€çš„ï¼Œè™½ç„¶ä¸€ç›´å­˜åœ¨ï¼Œä½†ä¹Ÿä¸è‡³äºé€ æˆä»€ä¹ˆä¸¥é‡çš„é—®é¢˜ï¼ŒTomcatå®ç°<a title="memory-leak-protection-tomcat" href="http://java.dzone.com/articles/memory-leak-protection-tomcat" target="_blank">Detection and Protection in Tomcat</a>æ˜¯ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾ï¼Ÿ

åŸæ¥å¹¶éè¿™ä¹ˆç®€å•ï¼ŒçœŸæ­£çš„ç½ªé­ç¥¸é¦–æ˜¯ClassLoader Memory Leakï¼ŒåŸºäºå¦‚ä¸‹é‡è¦äº‹å®:

<strong>0. ä¸€èˆ¬çš„åº”ç”¨æœåŠ¡å™¨æ¯”å¦‚Tomcatæˆ–è€…Glassfishå› ä¸ºè¦å®ç°åº”ç”¨çš„æ¨¡å—åŒ–ï¼Œä»è€Œå¯ä»¥åŠ¨æ€çš„undeployæˆ–è€…deployåº”ç”¨(.war, .ear, etc)ï¼Œ å¹¶ä¸”å¯ä»¥å®ç°<a title="çƒ­éƒ¨ç½²" href="http://baike.baidu.com/view/5036687.htm" target="_blank">çƒ­éƒ¨ç½²</a>ï¼Œä¸éœ€è¦é‡å¯æœåŠ¡å™¨ï¼Œæ‰€ä»¥æ¯ä¸ªåº”ç”¨éƒ½ä¼šæœ‰è‡ªå·±çš„WebappClassLoaderã€‚</strong>

<strong>1. æ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ¯”å¦‚XServlet instanceéƒ½ä¿æœ‰å®ƒå¯¹åº”classçš„å¼•ç”¨ï¼Œæ¯”å¦‚XServlet.class</strong>

<strong>2. æ¯ä¸€ä¸ªclasså¯¹è±¡ï¼Œæ¯”å¦‚XServlet.classæˆ–è€…åœ¨XServleté‡Œé¢ç¬¬ä¸€æ¬¡åŠ è½½çš„class, éƒ½ä¼šä¿æœ‰å½“å‰åŠ è½½å®ƒçš„é‚£ä¸ªclass loaderå¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯å½“å‰å¯¹è±¡çš„classloader.</strong>

<strong>3. æ¯ä¸ªclass loaderéƒ½ä¼šä¿æœ‰æ‰€æœ‰å®ƒåŠ è½½çš„classå¯¹è±¡çš„å¼•ç”¨ã€‚</strong>

å°±æ‹¿ä¸Šé¢çš„ThreadLocalä¸¾ä¾‹ï¼Œå› ä¸ºthreadLocal.get()é‡Œé¢å¼•ç”¨çš„å¯¹è±¡çš„classå¯èƒ½æ˜¯åœ¨å½“å‰WebappClassLoaderé‡Œé¢åŠ è½½çš„ï¼Œæ‰€ä»¥å¦‚æœundeployæ—¶ï¼Œå¦‚æœthreadLocalæ²¡æœ‰removeï¼Œé‚£ä¹ˆç›´æ¥å¯¼è‡´å½“å‰çš„appClassLoaderåŠå…¶åŠ è½½çš„æ‰€æœ‰å¯¹è±¡å’Œclassæ— æ³•å›æ”¶ï¼Œç»“æœå°±æ˜¯Memory Leak! å¦‚æœåŠ è½½çš„ç±»classä¸æ–­å˜å¤šï¼Œå ç”¨å†…å­˜è¶…è¿‡PermGenå¤§å°ï¼Œè¿˜ä¼šå¯¼è‡´"java.lang.OutOfMemoryError: PermGen space" å¼‚å¸¸ã€‚

<strong>ç»“è®º: å¦‚æœå½“å‰åº”ç”¨å¤–éƒ¨ä¿æœ‰å¯¹è±¡çš„ç±»classæ˜¯åœ¨æ”¹åº”ç”¨çš„classloaderä¸­åŠ è½½çš„ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ä¸€ä¸ªclassloaderæ³„æ¼ã€‚</strong>

è‡ªç„¶ï¼Œè¿™é‡Œçš„å½“å‰åº”ç”¨å¤–éƒ¨ä¿æœ‰çš„å¼•ç”¨å°±åŒ…æ‹¬å…¨å±€å¼•ç”¨å’ŒThreadLocalçº¿ç¨‹ä½œç”¨åŸŸå¼•ç”¨ï¼Œæ‰€ä»¥ä¸å…‰ThreadLocalè¦æ³¨æ„ï¼Œå…¶ä»–çš„åœ°æ–¹å¦‚å…¨å±€å˜é‡å¯èƒ½ä¹Ÿè¦æ³¨æ„ã€‚å¦å¤–ï¼Œç­‰å¾…Webå®¹å™¨è§£å†³è¿™ä¸ªé—®é¢˜æ˜¯ä¸ç°å®çš„ï¼Œ æˆ‘åœ¨æƒ³è¦ä¸è¦å¼„ä¸€ä¸ªRequestLocalä»£æ›¿ThreadLocalå’Œå…¶ä»–å…¨å±€å˜é‡ã€‚

å…³äºClassLoader Leaksï¼Œå‚è€ƒèµ„æ–™é‡Œé¢æœ‰ä¸¤ç¯‡è§£é‡Šçš„éå¸¸å¥½çš„æ–‡ç« ï¼Œç‰¹åˆ«æ˜¯é‡Œé¢ä¸¾äº†ä¸€ä¸ªå…¨å±€å˜é‡çš„ä¾‹å­ï¼Œéå¸¸ç”ŸåŠ¨ï¼šå°±ç®—å¦‚ä¸‹ä»£ç ä¹Ÿæ˜¯ä¼šæœ‰ç±»ä¼¼é—®é¢˜çš„ã€‚

&nbsp;
<pre escaped="true" lang="java" line="1">package com.stc.test;

import java.io.\*;
import java.util.logging.\*;
import javax.servlet.\*;
import javax.servlet.http.\*;

public class MyServlet extends HttpServlet {
protected void doGet(HttpServletRequest request, HttpServletResponse response)
throws ServletException, IOException {
// Log at a custom level
Level customLevel = new Level("OOPS", 555) {};
Logger.getLogger("test").log(customLevel, "doGet() called");
}
}</pre>
&nbsp;

å‚è€ƒèµ„æ–™ï¼š

[1]Â <a href="http://blogs.oracle.com/fkieviet/entry/classloader_leaks_the_dreaded_java">http://blogs.oracle.com/fkieviet/entry/classloader_leaks_the_dreaded_java</a>

[2]<a href="http://blogs.oracle.com/fkieviet/entry/how_to_fix_the_dreaded">http://blogs.oracle.com/fkieviet/entry/how_to_fix_the_dreaded</a>

[3]<a href="http://java.dzone.com/articles/memory-leak-protection-tomcat">http://java.dzone.com/articles/memory-leak-protection-tomcat</a>

[4]<a href="http://wiki.apache.org/tomcat/MemoryLeakProtection">http://wiki.apache.org/tomcat/MemoryLeakProtection</a>

[5]<a href="http://www.iteye.com/topic/75440">http://www.iteye.com/topic/75440</a>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/blog/2011/06/word_to_html" title="Javaå¹³å°åˆ©ç”¨OpenOfficeå®ç°ä¸åŒOfficeæ–‡ä»¶æ ¼å¼çš„è½¬åŒ–ï¼Œæ¯”å¦‚å°†Wordè½¬æ¢æˆHtml">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/blog/2011/06/jna-java-native" title="JNA, Java Nativeå¼€å‘åˆ©å™¨">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'hackfisher'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>28 June 2011</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#Java-ref">Java <span>9</span></a></li>
     
    	<li><a href="/tags.html#servlet-ref">servlet <span>1</span></a></li>
     
    	<li><a href="/tags.html#Tomcat-ref">Tomcat <span>1</span></a></li>
     
    	<li><a href="/tags.html#Web-ref">Web <span>2</span></a></li>
     
    	<li><a href="/tags.html#æ€§èƒ½ä¼˜åŒ–-ref">æ€§èƒ½ä¼˜åŒ– <span>6</span></a></li>
    
  



    </ul>
    
  </div>
</div>


		  </div>
    </div> <!-- /container -->

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30459154-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



    <!-- JiaThis Button BEGIN -->
<script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1344392196475354" charset="utf-8"></script>
<!-- JiaThis Button END -->
	<a target="_blank" href="http://vps.42qu.com/by/10022683" style="background:url(http://css42.42qu.us/png/42_39.png) #fff no-repeat ; line-height: 0; display: inline-block; height: 39px; padding-left: 48px; color:#000; text-decoration: none;"><span style="clear:both;margin-bottom:32px;"><span style="font-family: Trebuchet MS; line-height: 18px;"><span style="font-weight: bold; color:#d20; font-size: 19px;">VPS.42QU.COM</span><span style="margin-left: 1px; display: block; font-size: 12px; line-height: 14px; font-weight: bolder; margin-top: 4px;">ºÃÖ÷»ú <span style="margin:0 2px">,</span> Âô¸ø´´ÒµµÄÄã</span></span></span></a>
  </body>
</html>

